-- ============================================================
-- 031_extensions_schema.sql
-- Creates the "extensions" schema for PostgreSQL extensions installation.
-- Matches the grants in ExtensionService.installExtension (lines 312-326).
--
-- This ensures the schema exists BEFORE any extension installation attempt,
-- preventing "schema does not exist" errors on first install.
-- ============================================================

CREATE SCHEMA IF NOT EXISTS extensions;

-- Grant USAGE so all Cascata roles can access extension types and functions
DO $$ BEGIN
    GRANT USAGE ON SCHEMA extensions TO anon, authenticated, service_role, cascata_api_role;
EXCEPTION WHEN undefined_object THEN
    -- Roles may not exist yet in early bootstrap; safe to skip
    NULL;
END $$;

-- Set default privileges so future extension objects are accessible
DO $$ BEGIN
    ALTER DEFAULT PRIVILEGES IN SCHEMA extensions
        GRANT SELECT ON TABLES TO anon, authenticated, service_role, cascata_api_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA extensions
        GRANT EXECUTE ON FUNCTIONS TO anon, authenticated, service_role, cascata_api_role;
    ALTER DEFAULT PRIVILEGES IN SCHEMA extensions
        GRANT USAGE, SELECT ON SEQUENCES TO anon, authenticated, service_role, cascata_api_role;
EXCEPTION WHEN undefined_object THEN
    NULL;
END $$;

-- Add extensions schema to search_path so extension types are globally accessible
DO $$
BEGIN
    EXECUTE format(
        'ALTER DATABASE %I SET search_path TO "$user", public, extensions',
        current_database()
    );
END $$;
